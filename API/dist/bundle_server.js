(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var s in a)e.o(a,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:a[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("express");var a=e.n(t);const s=require("cors");var o=e.n(s);const n=require("request");var r=e.n(n);const i=a()();function c(e){return new Promise((function(t,a){r().get({url:e,json:!0,headers:{"User-Agent":"request"}},((e,s,o)=>{e?(a(e),console.log("error:",e)):200!==s.statusCode?console.log("Status:",s.statusCode):t(o)}))}))}async function l(e,t){let a=`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${e}&apikey=546M72GB5ZUMCF4H`;return"wait"==t?new Promise((function(e,t){setTimeout((async function(){e(await c(a))}),15e3)})):await c(a)}i.use(a().json()),i.use(a().urlencoded({extended:!0})),i.use(a().static("dist/public")),i.use(o()()),i.get("/",(function(e,t){t.send('<!DOCTYPE html>\n    <html lang="en">\n    <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <title>Servidor</title>\n    </head>\n        <body>\n           Rodando ...\n        </body>\n    </html>')})),i.get("/stocks/:stock_name/quote",(async function(e,t){const{stock_name:a}=e.params;let s=`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${a}&apikey=CPU4KCW6RXDDUY2L`,o=await c(s);if(0==o.bestMatches.length)return t.status(404),void t.send({error:"Empresa não encontrada"});let n=await l(o.bestMatches[0]["1. symbol"]);try{t.status(200),t.send({name:o.bestMatches[0]["1. symbol"],lastPrice:parseFloat(n["Global Quote"]["05. price"]),pricedAt:new Date(n["Global Quote"]["07. latest trading day"])})}catch{t.status(404),t.send({error:"Limite de solicitação excedida"})}})),i.get("/stocks/:stock_name/history",(async function(e,t){const{stock_name:a}=e.params;let s=new Date(e.query.from),o=new Date(e.query.to);if(s>o)return t.status(403),void t.send({error:"Data final menor que a inicial"});let n=`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${a}&apikey=CPU4KCW6RXDDUY2L`,r=await c(n);if(0==r.bestMatches.length)return t.status(404),void t.send({error:"Empresa não encontrada"});n=`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${r.bestMatches[0]["1. symbol"]}&apikey=CPU4KCW6RXDDUY2L`;let i=await c(n),l=new Array;for(;s<=o;)s.setDate(s.getDate()+1),l.push(s.toLocaleDateString("zh-Hans-CN",{year:"numeric",month:"2-digit",day:"2-digit"}));let u=new Array;l.forEach((e=>{i["Time Series (Daily)"][e]&&u.push({opening:parseFloat(i["Time Series (Daily)"][e]["1. open"]),low:parseFloat(i["Time Series (Daily)"][e]["3. low"]),high:parseFloat(i["Time Series (Daily)"][e]["2. high"]),closing:parseFloat(i["Time Series (Daily)"][e]["4. close"]),pricedAt:e})})),t.status(200),t.send({name:r.bestMatches[0]["1. symbol"],prices:u})})),i.post("/stocks/:stock_name/compare",(async function(e,t){const{stock_name:a}=e.params;let s=e.body.stocks,o=new Array;for(var n=0;n<s.length;n++){let e=`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${s[n]}&apikey=CPU4KCW6RXDDUY2L`,t=await c(e);if(0!=t.bestMatches.length){let e=await l(t.bestMatches[0]["1. symbol"],"wait");o.push({name:t.bestMatches[0]["1. symbol"],lastPrice:parseFloat(e["Global Quote"]["05. price"]),pricedAt:e["Global Quote"]["07. latest trading day"]})}}if(0==o.length)return t.status(404),void t.send({error:"Nenhuma empresa encontrada"});t.status(200),t.send({lastPrices:o})})),i.get("/stocks/:stock_name/gains",(async function(e,t){const{stock_name:a}=e.params;let s=parseInt(e.query.purchasedAmount),o=e.query.purchasedAt,n=`https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${a}&apikey=CPU4KCW6RXDDUY2L`,r=await c(n);if(0==r.bestMatches.length)return t.status(404),void t.send({error:"Empresa não encontrada"});let i=await l(r.bestMatches[0]["1. symbol"]);n=`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${r.bestMatches[0]["1. symbol"]}&outputsize=full&apikey=demo`;let u=await c(n);try{t.status(200),t.send({name:r.bestMatches[0]["1. symbol"],purchasedAmount:s,purchasedAt:o,priceAtDate:parseFloat(u["Time Series (Daily)"][o]["4. close"]),lastPrice:parseFloat(i["Global Quote"]["05. price"]),capitalGains:parseFloat(i["Global Quote"]["05. price"])*s-parseFloat(u["Time Series (Daily)"][o]["4. close"])*s})}catch{t.status(404),t.send({error:"Data não disponivel"})}})),i.listen(3030,(function(){console.log("Servidor esta ouvindo na porta 3030")}))})();